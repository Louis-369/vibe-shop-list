<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¬ã®è²·ã„ç‰©æ¸…å–®</title>
    
    <!-- PWA / Mobile App Optimization for Deployment -->
    <meta name="theme-color" content="#f9f7f2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è³¼ç‰©æ¸…å–®">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›ï¸</text></svg>">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="> <!-- Placeholder, real icon recommended -->

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Import Japanese/Cute Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f9f7f2;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            color: #57534e;
            padding-bottom: 100px; /* Space for FAB */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1; 
            border-radius: 10px;
        }

        /* Cute Checkbox Animation */
        .cute-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.6em;
            height: 1.6em;
            border: 2px solid #e7e5e4;
            border-radius: 50%;
            display: grid;
            place-content: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            flex-shrink: 0;
        }
        .cute-checkbox::before {
            content: "\f00c"; /* FontAwesome check */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.9em;
            color: white;
            transform: scale(0);
            transition: 0.2s transform ease-in-out;
        }
        .cute-checkbox:checked {
            border-color: transparent;
        }
        .cute-checkbox:checked::before {
            transform: scale(1);
        }

        /* Paper texture */
        .washi-card {
            background-color: #fffbf0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.05), 
                0 4px 6px -2px rgba(0, 0, 0, 0.02),
                0 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .handwritten {
            font-family: 'Yomogi', cursive;
        }

        /* Strikethrough animation */
        .strike-through {
            position: relative;
            color: #a8a29e;
        }
        .strike-through::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #a8a29e;
            transform: scaleX(0);
            transform-origin: left;
            animation: strike 0.3s ease-out forwards;
        }
        @keyframes strike {
            to { transform: scaleX(1); }
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            z-index: 40;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.open {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-backdrop.open .modal-content {
            transform: translateY(0);
        }

        /* Image Preview */
        .image-preview-box {
            width: 100%;
            height: 120px;
            background-color: #f5f5f4;
            border: 2px dashed #d6d3d1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .image-preview-box:active {
            transform: scale(0.98);
            background-color: #ebebeb;
        }
        .image-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Auto Generated Avatar */
        .auto-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Chips / Tags */
        .chip-btn {
            transition: all 0.2s;
            transform: scale(1);
        }
        .chip-btn:active {
            transform: scale(0.95);
        }
        
        /* Smooth transition for layout changes */
        .list-move,
        .list-enter-active,
        .list-leave-active {
          transition: all 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 transition-colors duration-500" id="main-body">

    <!-- Main Container -->
    <div class="washi-card w-full max-w-lg rounded-[32px] overflow-hidden relative border-2 border-stone-100 flex flex-col shadow-2xl">
        
        <!-- Decorative Header Section -->
        <div id="header-bg" class="pt-8 pb-6 px-6 relative transition-colors duration-500">
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-20 pointer-events-none">
                <i id="season-icon-bg" class="fa-solid fa-seedling absolute -top-10 -right-10 text-9xl transform rotate-12"></i>
            </div>

            <div class="relative z-10 text-center">
                <div class="inline-flex items-center justify-center gap-2 bg-white/80 backdrop-blur-sm px-4 py-1 rounded-full shadow-sm mb-2">
                    <i id="season-icon-sm" class="text-sm"></i>
                    <span id="solar-term-text" class="text-sm font-bold tracking-widest text-stone-600">...</span>
                </div>
                <h1 class="text-3xl font-bold text-stone-700 tracking-wide mb-1 handwritten">ãŠè²·ã„ç‰©æ¸…å–®</h1>
                
                <!-- Rate Info -->
                <div class="flex justify-center items-center gap-2 mt-2">
                    <span class="text-[10px] bg-white/60 px-2 py-1 rounded-md text-stone-500 cursor-pointer" onclick="fetchRates()" title="é»æ“Šæ›´æ–°åŒ¯ç‡">
                        <i class="fa-solid fa-rotate text-xs mr-1"></i>
                        <span id="rate-display">è¼‰å…¥åŒ¯ç‡ä¸­...</span>
                    </span>
                </div>
            </div>

            <!-- Cute Progress Bar -->
            <div class="mt-6 relative">
                <div class="flex justify-between text-xs font-bold text-stone-600 mb-1 px-1">
                    <span class="handwritten">é€²åº¦</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-white/50 rounded-full h-4 p-1 shadow-inner border border-white/40">
                    <div id="progress-bar" class="h-2 rounded-full transition-all duration-700 ease-out w-0 relative">
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter & Sort Controls -->
        <div class="bg-white/40 backdrop-blur-md sticky top-0 z-20 border-b border-stone-100 px-4 py-3">
            <!-- Tabs -->
            <div class="flex justify-center gap-2 mb-3">
                <button onclick="setFilter('all')" id="tab-all" class="px-4 py-1.5 rounded-2xl text-xs font-bold transition-all border-2 border-transparent">å…¨éƒ¨</button>
                <button onclick="setFilter('active')" id="tab-active" class="px-4 py-1.5 rounded-2xl text-xs font-bold transition-all border-2 border-transparent">æœªå®Œæˆ</button>
                <button onclick="setFilter('completed')" id="tab-completed" class="px-4 py-1.5 rounded-2xl text-xs font-bold transition-all border-2 border-transparent">å·²å®Œæˆ</button>
            </div>
            
            <!-- Advanced Sort Toolbar -->
            <div class="flex justify-between items-center px-1 gap-2">
                <!-- Sort Controls Group -->
                <div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-stone-200 shadow-sm">
                    <div class="relative">
                        <select onchange="setSortField(this.value)" class="appearance-none bg-transparent text-stone-600 text-[11px] font-bold pl-2 pr-6 py-1 focus:outline-none cursor-pointer">
                            <option value="date">ğŸ“… åŠ å…¥æ™‚é–“</option>
                            <option value="price">ğŸ’° é ä¼°é‡‘é¡</option>
                            <option value="category">ğŸ“‚ å•†å“åˆ†é¡</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1 text-stone-400">
                            <i class="fa-solid fa-chevron-down text-[10px]"></i>
                        </div>
                    </div>
                    <div class="w-px h-4 bg-stone-200"></div>
                    <button onclick="toggleSortDirection()" id="sort-dir-btn" class="px-2 py-1 text-stone-500 hover:text-stone-700 transition-colors text-[10px]">
                        <i class="fa-solid fa-arrow-down-long"></i>
                    </button>
                </div>

                <!-- Contextual Clear Button (Hidden by default) -->
                <button id="clear-btn" onclick="clearCompleted()" class="hidden text-[10px] text-red-400 hover:text-red-500 bg-red-50 px-3 py-1.5 rounded-xl transition-colors font-bold shadow-sm border border-red-100">
                    <i class="fa-solid fa-trash-can mr-1"></i> æ¸…é™¤ç´€éŒ„
                </button>
            </div>
        </div>

        <!-- List Area -->
        <div class="px-4 pb-20 min-h-[400px] bg-stone-50/30">
            <div id="empty-state" class="hidden flex-col items-center justify-center py-16 text-stone-300">
                <div class="bg-white p-6 rounded-full mb-4 shadow-sm animate-bounce">
                    <i class="fa-regular fa-face-smile text-4xl text-stone-200"></i>
                </div>
                <p class="handwritten text-lg">ç›®å‰æ²’æœ‰å¾…è²·é …ç›®å‘¦</p>
                <button onclick="openModal()" class="mt-4 text-sm text-stone-400 hover:text-stone-600 underline">æŒ‰å³ä¸‹è§’ç›¸æ©Ÿæ–°å¢</button>
            </div>
            
            <ul id="shopping-list" class="space-y-3 py-4">
                <!-- Items injected here -->
            </ul>
        </div>

        <!-- Footer / Backup Controls -->
        <div class="p-4 bg-stone-100 border-t border-stone-200 flex flex-col gap-3 text-xs text-stone-500 rounded-b-[30px]">
            <div class="flex justify-center gap-2 w-full">
                <button onclick="exportData()" class="flex-1 bg-white border border-stone-200 px-3 py-2 rounded-xl hover:bg-stone-50 flex justify-center items-center gap-1 shadow-sm text-[10px]">
                    <i class="fa-solid fa-file-export"></i> ä¸‹è¼‰å‚™ä»½
                </button>
                <button onclick="copyDataToClipboard()" class="flex-1 bg-white border border-stone-200 px-3 py-2 rounded-xl hover:bg-stone-50 flex justify-center items-center gap-1 shadow-sm text-[10px]">
                    <i class="fa-regular fa-clipboard"></i> è¤‡è£½å‚™ä»½ç¢¼
                </button>
            </div>
            
            <!-- Import Action -->
            <div class="flex items-center justify-center gap-2 pt-1">
                <button onclick="triggerImport()" class="text-[10px] text-stone-400 hover:text-stone-600 underline decoration-dotted">
                    ä¸Šå‚³é‚„åŸ
                </button>
                <span class="text-[10px] text-stone-300">|</span>
                <button onclick="importFromClipboard()" class="text-[10px] text-stone-400 hover:text-stone-600 underline decoration-dotted">
                    è²¼ä¸Šå‚™ä»½ç¢¼é‚„åŸ
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="openModal()" id="fab-btn" class="fixed bottom-8 right-6 w-16 h-16 rounded-full shadow-xl text-white flex items-center justify-center text-2xl transition-transform hover:scale-110 active:scale-95 z-30">
        <i class="fa-solid fa-camera"></i>
    </button>

    <!-- Purchase Confirmation Modal -->
    <div id="purchase-modal" class="modal-backdrop items-center justify-center p-4 z-50">
        <div class="modal-content bg-white w-full max-w-sm rounded-[32px] shadow-2xl overflow-hidden flex flex-col relative">
            <!-- Cute Decoration -->
            <div class="absolute -top-6 -right-6 w-24 h-24 bg-yellow-200 rounded-full opacity-50 blur-xl"></div>
            <div class="absolute -bottom-6 -left-6 w-28 h-28 bg-pink-200 rounded-full opacity-50 blur-xl"></div>

            <div class="p-6 relative z-10 text-center">
                <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl shadow-sm animate-bounce">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2 class="text-xl font-bold text-stone-700 mb-1 handwritten">æ­å–œå…¥æ‰‹ï¼</h2>
                <p class="text-xs text-stone-400 mb-5">ç´€éŒ„ä¸€ä¸‹æˆ°åˆ©å“å§ï¼Ÿ</p>

                <div class="bg-stone-50 p-4 rounded-2xl border border-stone-100 mb-5 text-left space-y-4">
                    <!-- Photo Upload -->
                    <div class="flex items-center gap-3">
                        <div onclick="document.getElementById('purchase-img-upload').click()" class="w-16 h-16 bg-white border-2 border-dashed border-stone-300 rounded-xl flex items-center justify-center text-stone-300 cursor-pointer hover:border-stone-400 hover:text-stone-400 transition-colors flex-shrink-0 overflow-hidden relative">
                            <img id="purchase-img-preview" class="hidden w-full h-full object-cover absolute inset-0">
                            <i class="fa-solid fa-camera text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-stone-500 mb-1">æ‹å¼µç…§ç´€éŒ„ (é¸å¡«)</p>
                            <p class="text-[10px] text-stone-400">ç™¼ç¥¨æˆ–å•†å“å¯¦é«”</p>
                            <input type="file" id="purchase-img-upload" accept="image/*" class="hidden" onchange="handleImageUpload(this, 'purchase-img-preview')">
                        </div>
                    </div>

                    <div class="h-px bg-stone-200/50"></div>

                    <!-- Price Input -->
                    <div>
                        <label class="block text-[10px] font-bold text-stone-400 mb-1">å¯¦éš›èŠ±è²»é‡‘é¡</label>
                        <div class="flex gap-2">
                            <select id="purchase-currency" class="w-20 px-2 py-2 bg-white border border-stone-200 rounded-xl text-xs font-bold text-stone-600">
                                <option value="JPY">JPY</option>
                                <option value="TWD">TWD</option>
                                <option value="USD">USD</option>
                                <option value="KRW">KRW</option>
                            </select>
                            <input type="number" id="purchase-price" class="flex-1 px-3 py-2 bg-white border border-stone-200 rounded-xl focus:outline-none focus:border-green-400 text-sm font-bold text-stone-600" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="confirmPurchase('simple')" class="py-3 rounded-xl border border-stone-200 text-stone-500 font-bold text-xs hover:bg-stone-50 transition-colors">
                        ç›´æ¥æ‰“å‹¾
                    </button>
                    <button onclick="confirmPurchase('detailed')" class="py-3 rounded-xl bg-green-400 text-white font-bold text-xs shadow-md hover:bg-green-500 transition-colors hover:shadow-lg">
                        æ›´æ–°ä¸¦å®Œæˆ
                    </button>
                </div>
                <button onclick="closePurchaseModal()" class="mt-4 text-[10px] text-stone-300 underline">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="modal-backdrop" class="modal-backdrop items-end sm:items-center justify-center p-4 z-50">
        <div class="modal-content bg-white w-full max-w-md rounded-[32px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50/80 backdrop-blur">
                <h2 class="text-lg font-bold text-stone-700 handwritten">æ–°å¢è³¼ç‰©é …ç›®</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-stone-100 text-stone-400 flex items-center justify-center hover:bg-stone-200 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <form id="add-form" class="space-y-5">
                    
                    <!-- 1. Image Upload (Prominent) -->
                    <div class="w-full">
                        <div class="image-preview-box shadow-inner" onclick="document.getElementById('input-img-file').click()">
                            <div id="img-placeholder-content" class="flex flex-col items-center text-stone-300 pointer-events-none">
                                <i class="fa-solid fa-camera text-3xl mb-2 text-stone-200"></i>
                                <span class="text-xs font-bold">é»æ“Šæ‹å•†å“ç…§æˆ–ä¸Šå‚³</span>
                            </div>
                            <img id="img-preview" src="" class="hidden absolute inset-0 w-full h-full object-cover">
                        </div>
                        <input type="file" id="input-img-file" accept="image/*" class="hidden" onchange="handleImageUpload(this, 'img-preview')">
                    </div>

                    <!-- 2. Category & Name -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-stone-400 mb-1">åˆ†é¡ (å¹«æ‚¨è‡ªå‹•ç”Ÿæˆåœ–ç¤º)</label>
                            <div class="relative">
                                <select id="input-category" onchange="updateTagOptions()" class="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-400 text-sm appearance-none font-bold text-stone-600">
                                    <option value="general">ğŸ ä¸€èˆ¬é›œè²¨</option>
                                    <option value="cosmetic">ğŸ’„ è—¥å¦ / ä¿é¤Š</option>
                                    <option value="clothing">ğŸ‘— æœé£¾ / é…ä»¶</option>
                                    <option value="food">ğŸ˜ é›¶é£Ÿ / é£Ÿå“</option>
                                    <option value="electronics">ğŸ“· é›»å™¨ / 3C</option>
                                    <option value="baby">ğŸ‘¶ å¬°å¹¼å…’</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-stone-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-stone-400 mb-1">å•†å“åç¨± *</label>
                            <input type="text" id="input-name" required placeholder="ä¾‹å¦‚: è¶…å¥½ç”¨é˜²æ›¬" 
                                class="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-colors text-sm font-bold text-stone-600">
                        </div>
                    </div>

                    <!-- 3. Smart Tags & Note -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-stone-400">å¿«é€Ÿè¦æ ¼ / å‚™è¨»</label>
                        </div>
                        
                        <!-- Dynamic Tag Cloud -->
                        <div id="tag-cloud" class="flex flex-wrap gap-2 mb-3">
                            <!-- Populated by JS -->
                        </div>

                        <textarea id="input-note" rows="2" placeholder="é¸å¡«ï¼šæ‰‹å‹•è¼¸å…¥è©³ç´°è³‡è¨Š..." 
                            class="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-colors text-xs text-stone-600 resize-none"></textarea>
                    </div>

                    <!-- 4. Price -->
                    <div class="bg-stone-50 p-4 rounded-2xl border border-stone-100">
                        <div class="flex items-end gap-3 mb-2">
                            <div class="flex-1">
                                <label class="block text-[10px] font-bold text-stone-400 mb-1">é ä¼°åƒ¹æ ¼</label>
                                <input type="number" id="input-price" placeholder="0" 
                                    class="w-full px-3 py-2 bg-white border border-stone-200 rounded-xl focus:outline-none focus:border-stone-400 text-sm font-bold text-stone-600">
                            </div>
                            <div class="w-24">
                                <label class="block text-[10px] font-bold text-stone-400 mb-1">å¹£åˆ¥</label>
                                <select id="input-currency" class="w-full px-2 py-2 bg-white border border-stone-200 rounded-xl focus:outline-none focus:border-stone-400 text-xs font-bold text-stone-500">
                                    <option value="JPY">JPY æ—¥åœ“</option>
                                    <option value="TWD">TWD å°å¹£</option>
                                    <option value="USD">USD ç¾é‡‘</option>
                                    <option value="KRW">KRW éŸ“å…ƒ</option>
                                    <option value="CNY">CNY äººæ°‘å¹£</option>
                                    <option value="EUR">EUR æ­å…ƒ</option>
                                </select>
                            </div>
                        </div>
                        <div id="price-preview" class="text-right text-xs text-stone-500 font-bold h-4"></div>
                    </div>
                    
                    <!-- Hidden URL Input (optional toggle could be added, but keeping it simple as requested) -->
                    <div class="hidden">
                         <input type="url" id="input-url">
                    </div>

                </form>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-stone-100 bg-stone-50 flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 rounded-2xl text-stone-500 font-bold hover:bg-stone-200 transition-colors text-sm">å–æ¶ˆ</button>
                <button onclick="addItem()" id="modal-confirm-btn" class="flex-1 py-3 rounded-2xl text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all text-sm">
                    åŠ å…¥æ¸…å–®
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Solar Term & Season Logic ---
        const solarTerms = [
            { name: "å°å¯’", date: "01-05" }, { name: "å¤§å¯’", date: "01-20" },
            { name: "ç«‹æ˜¥", date: "02-04" }, { name: "é›¨æ°´", date: "02-19" },
            { name: "é©šèŸ„", date: "03-05" }, { name: "æ˜¥åˆ†", date: "03-20" },
            { name: "æ¸…æ˜", date: "04-04" }, { name: "ç©€é›¨", date: "04-19" },
            { name: "ç«‹å¤", date: "05-05" }, { name: "å°æ»¿", date: "05-21" },
            { name: "èŠ’ç¨®", date: "06-05" }, { name: "å¤è‡³", date: "06-21" },
            { name: "å°æš‘", date: "07-07" }, { name: "å¤§æš‘", date: "07-22" },
            { name: "ç«‹ç§‹", date: "08-07" }, { name: "è™•æš‘", date: "08-23" },
            { name: "ç™½éœ²", date: "09-07" }, { name: "ç§‹åˆ†", date: "09-23" },
            { name: "å¯’éœ²", date: "10-08" }, { name: "éœœé™", date: "10-23" },
            { name: "ç«‹å†¬", date: "11-07" }, { name: "å°é›ª", date: "11-22" },
            { name: "å¤§é›ª", date: "12-07" }, { name: "å†¬è‡³", date: "12-21" }
        ];

        const seasons = {
            spring: { color: "bg-pink-50", accent: "text-pink-500", btn: "bg-pink-400", checked: "#f472b6", icon: "fa-fan" },
            summer: { color: "bg-sky-50", accent: "text-sky-500", btn: "bg-sky-400", checked: "#38bdf8", icon: "fa-sun" },
            autumn: { color: "bg-orange-50", accent: "text-orange-500", btn: "bg-orange-400", checked: "#fb923c", icon: "fa-leaf" },
            winter: { color: "bg-slate-50", accent: "text-slate-500", btn: "bg-slate-400", checked: "#94a3b8", icon: "fa-snowflake" }
        };

        let currentTheme = {};

        function getSolarTerm() {
            const now = new Date();
            const todayVal = (now.getMonth() + 1) * 100 + now.getDate();
            let currentTerm = solarTerms[solarTerms.length - 1];
            for (let i = 0; i < solarTerms.length; i++) {
                const [m, d] = solarTerms[i].date.split('-').map(Number);
                if (todayVal >= m * 100 + d) currentTerm = solarTerms[i];
                else break;
            }
            return currentTerm;
        }

        function getSeason(month) {
            if (month >= 2 && month <= 4) return 'spring';
            if (month >= 5 && month <= 7) return 'summer';
            if (month >= 8 && month <= 10) return 'autumn';
            return 'winter';
        }

        function applyTheme() {
            const term = getSolarTerm();
            const now = new Date();
            const seasonKey = getSeason(now.getMonth() + 1);
            const theme = seasons[seasonKey];
            currentTheme = theme;

            document.getElementById('solar-term-text').textContent = `${term.name} Â· ${seasonKey.toUpperCase()}`;
            
            const iconClass = theme.icon;
            document.getElementById('season-icon-bg').className = `fa-solid ${iconClass} absolute -top-10 -right-10 text-9xl transform rotate-12 text-white`;
            document.getElementById('season-icon-sm').className = `fa-solid ${iconClass} ${theme.accent}`;
            document.getElementById('header-bg').classList.add(theme.color);
            document.getElementById('progress-bar').classList.add(theme.btn);
            document.getElementById('fab-btn').classList.add(theme.btn);
            document.getElementById('modal-confirm-btn').classList.add(theme.btn);
            
            document.documentElement.style.setProperty('--checkbox-color', theme.checked);
        }

        // --- 2. Currency Logic ---
        let exchangeRates = { TWD: 1, JPY: 0.215, USD: 31.5, KRW: 0.024, CNY: 4.4, EUR: 34.5 }; 
        
        async function fetchRates() {
            const display = document.getElementById('rate-display');
            display.textContent = "æ›´æ–°ä¸­...";
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                if(response.ok) {
                    const data = await response.json();
                    const newRates = {};
                    for (const [key, value] of Object.entries(data.rates)) {
                        newRates[key] = 1 / value;
                    }
                    exchangeRates = { ...exchangeRates, ...newRates };
                    display.textContent = `1 JPY â‰ˆ ${exchangeRates.JPY.toFixed(3)} TWD`;
                    render(); 
                    updatePricePreview();
                }
            } catch (e) {
                console.log("Rate fetch failed", e);
                display.textContent = "ä½¿ç”¨é è¨­åŒ¯ç‡ (æ›´æ–°å¤±æ•—)";
            }
        }

        function calculateTWD(amount, currency) {
            if (!amount || !currency) return 0;
            if (currency === 'TWD') return amount;
            const rate = exchangeRates[currency] || 0;
            return Math.round(amount * rate);
        }

        // --- 3. Category & Tags Logic ---
        const categoryData = {
            'general': { icon: 'fa-gift', color: '#fed7aa', tags: ['é™å®š', 'é€ç¦®'] },
            'cosmetic': { icon: 'fa-spray-can-sparkles', color: '#fbcfe8', tags: ['#01', '#02', 'è‡ªç„¶è‰²', 'äº®ç™½', '50ml', '100ml', 'ä¿æ¿•', 'é˜²æ›¬'] },
            'clothing': { icon: 'fa-shirt', color: '#bae6fd', tags: ['S', 'M', 'L', 'XL', 'F', 'é»‘', 'ç™½', 'ç±³', 'è—'] },
            'food': { icon: 'fa-cookie-bite', color: '#fde68a', tags: ['è¾£å‘³', 'èµ·å¸', 'æŠ¹èŒ¶', 'è‰è“', 'å¤§åŒ…', 'ç›’è£'] },
            'electronics': { icon: 'fa-camera', color: '#e2e8f0', tags: ['é›»æ± ', 'è¨˜æ†¶å¡', '110V', '220V'] },
            'baby': { icon: 'fa-baby', color: '#d9f99d', tags: ['NB', 'S', 'M', 'L', 'ç´”æ£‰'] }
        };

        function updateTagOptions() {
            const category = document.getElementById('input-category').value;
            const tagContainer = document.getElementById('tag-cloud');
            tagContainer.innerHTML = '';
            
            const tags = categoryData[category].tags;
            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'chip-btn text-[10px] px-3 py-1.5 rounded-full bg-stone-100 text-stone-500 border border-stone-200 hover:bg-stone-200 hover:border-stone-300 font-bold';
                btn.textContent = tag;
                btn.onclick = () => addTagToNote(tag);
                tagContainer.appendChild(btn);
            });
        }

        function addTagToNote(tag) {
            const noteInput = document.getElementById('input-note');
            const currentVal = noteInput.value;
            if(currentVal) {
                noteInput.value = currentVal + ' ' + tag;
            } else {
                noteInput.value = tag;
            }
        }

        // --- 4. Image Handling (Resize & Compression) ---
        // IMPORTANT: LocalStorage has 5MB limit. We must compress images.
        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300; // Thumbnail size
                    const MAX_HEIGHT = 300;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG 0.7 quality
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        let tempImgBase64 = ''; // Stores the image string for the modal
        let tempPurchaseImgBase64 = '';

        function handleImageUpload(input, previewId) {
            if (input.files && input.files[0]) {
                resizeImage(input.files[0], (base64) => {
                    if(previewId === 'img-preview') {
                         tempImgBase64 = base64;
                         document.getElementById('img-placeholder-content').classList.add('hidden');
                    } else {
                         tempPurchaseImgBase64 = base64;
                    }
                    
                    const preview = document.getElementById(previewId);
                    preview.src = base64;
                    preview.classList.remove('hidden');
                });
            }
        }

        // --- 5. App Logic ---
        let items = JSON.parse(localStorage.getItem('shoppingList')) || [];
        let currentFilter = 'all';
        let sortField = 'date'; // date, price, category
        let sortDirection = 'desc'; // asc, desc

        // DOM Elements
        const modal = document.getElementById('modal-backdrop');
        const purchaseModal = document.getElementById('purchase-modal');
        const inputPrice = document.getElementById('input-price');
        const inputCurrency = document.getElementById('input-currency');
        const pricePreview = document.getElementById('price-preview');

        let itemToCompleteId = null;

        function openModal() {
            document.getElementById('add-form').reset();
            document.getElementById('input-category').value = 'general';
            document.getElementById('img-preview').classList.add('hidden');
            document.getElementById('img-placeholder-content').classList.remove('hidden');
            tempImgBase64 = '';
            pricePreview.textContent = '';
            updateTagOptions();
            modal.classList.add('open');
        }

        function closeModal() {
            modal.classList.remove('open');
        }

        function updatePricePreview() {
            const val = parseFloat(inputPrice.value);
            const curr = inputCurrency.value;
            if(!isNaN(val) && curr !== 'TWD') {
                const twd = calculateTWD(val, curr);
                pricePreview.textContent = `ç´„ NT$ ${twd.toLocaleString()}`;
            } else {
                pricePreview.textContent = '';
            }
        }

        inputPrice.addEventListener('input', updatePricePreview);
        inputCurrency.addEventListener('change', updatePricePreview);

        // CRUD
        function addItem() {
            const name = document.getElementById('input-name').value.trim();
            if (!name) return;

            const newItem = {
                id: Date.now(),
                text: name,
                category: document.getElementById('input-category').value,
                img: tempImgBase64, // Store Base64
                price: parseFloat(document.getElementById('input-price').value) || 0,
                currency: document.getElementById('input-currency').value,
                note: document.getElementById('input-note').value.trim(),
                url: document.getElementById('input-url').value.trim(),
                completed: false,
                createdAt: new Date().getTime(), // Store timestamp number
                actualPrice: null,
                actualCurrency: null,
                purchaseImg: null
            };

            items.unshift(newItem);
            saveAndRender();
            closeModal();
        }

        function toggleItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            if (!item.completed) {
                // Show Purchase Modal
                itemToCompleteId = id;
                document.getElementById('purchase-currency').value = item.currency || 'JPY';
                document.getElementById('purchase-price').value = item.price || '';
                document.getElementById('purchase-img-preview').classList.add('hidden');
                tempPurchaseImgBase64 = '';
                purchaseModal.classList.add('open');
            } else {
                // Uncheck
                items = items.map(item => {
                    if (item.id === id) return { ...item, completed: false };
                    return item;
                });
                saveAndRender();
            }
        }

        function confirmPurchase(type) {
            if (!itemToCompleteId) return;

            const actualPrice = parseFloat(document.getElementById('purchase-price').value);
            const actualCurrency = document.getElementById('purchase-currency').value;

            items = items.map(item => {
                if (item.id === itemToCompleteId) {
                    const updated = { ...item, completed: true, completedAt: new Date().getTime() };
                    
                    if (type === 'detailed') {
                        if (!isNaN(actualPrice)) {
                            updated.actualPrice = actualPrice;
                            updated.actualCurrency = actualCurrency;
                        }
                        if (tempPurchaseImgBase64) {
                            updated.purchaseImg = tempPurchaseImgBase64;
                        }
                    }
                    return updated;
                }
                return item;
            });

            closePurchaseModal();
            saveAndRender();
        }

        function closePurchaseModal() {
            purchaseModal.classList.remove('open');
            itemToCompleteId = null;
            render(); 
        }

        function deleteItem(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                items = items.filter(item => item.id !== id);
                saveAndRender();
            }
        }

        function clearCompleted() {
            if (!items.some(item => item.completed)) return;
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ã€Œå·²å®Œæˆã€çš„é …ç›®å—ï¼Ÿ')) {
                items = items.filter(item => !item.completed);
                saveAndRender();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            render();
        }

        function setSortField(field) {
            sortField = field;
            render();
        }

        function toggleSortDirection() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            const btn = document.getElementById('sort-dir-btn');
            btn.innerHTML = sortDirection === 'asc' ? '<i class="fa-solid fa-arrow-up-long"></i>' : '<i class="fa-solid fa-arrow-down-long"></i>';
            render();
        }

        function saveAndRender() {
            try {
                localStorage.setItem('shoppingList', JSON.stringify(items));
            } catch (e) {
                alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼è«‹åˆªé™¤ä¸€äº›é …ç›®æˆ–ä¸è¦ä¸Šå‚³å¤ªå¤šç…§ç‰‡ã€‚");
            }
            render();
        }

        // --- 6. Backup & Restore ---
        function exportData() {
            const dataStr = JSON.stringify(items, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `shopping_list_backup_${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyDataToClipboard() {
            const dataStr = JSON.stringify(items);
            navigator.clipboard.writeText(dataStr).then(() => {
                alert("å‚™ä»½ç¢¼å·²è¤‡è£½ï¼\nè«‹è²¼åˆ° Apple å‚™å¿˜éŒ„ä¿å­˜ã€‚");
            });
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { processImport(e.target.result); };
            reader.readAsText(file);
            input.value = ''; 
        }

        async function importFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    if(confirm("ç¢ºå®šè¦é‚„åŸå—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡æœƒè¢«è¦†è“‹ã€‚")) processImport(text);
                }
            } catch (err) { alert("ç„¡æ³•è®€å–å‰ªè²¼ç°¿"); }
        }

        function processImport(jsonString) {
            try {
                const json = JSON.parse(jsonString);
                if (Array.isArray(json)) {
                    items = json;
                    saveAndRender();
                    alert('é‚„åŸæˆåŠŸï¼');
                } else { alert('æ ¼å¼éŒ¯èª¤'); }
            } catch (err) { alert('è³‡æ–™ææ¯€'); }
        }

        // --- 7. Render ---
        function render() {
            // Tabs styling
            ['all', 'active', 'completed'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (t === currentFilter) {
                    el.className = `px-4 py-1.5 rounded-2xl text-xs font-bold transition-all border-2 bg-white text-stone-700 shadow-sm`;
                    el.style.borderColor = currentTheme.checked || '#ccc';
                    el.style.color = currentTheme.checked || '#555';
                } else {
                    el.className = `px-4 py-1.5 rounded-2xl text-xs font-bold transition-all border-2 border-transparent text-stone-400 hover:bg-white/50`;
                    el.style.borderColor = 'transparent';
                    el.style.color = '';
                }
            });

            // Filter
            let filteredItems = items;
            if (currentFilter === 'active') filteredItems = items.filter(item => !item.completed);
            else if (currentFilter === 'completed') filteredItems = items.filter(item => item.completed);

            // Sort
            filteredItems.sort((a, b) => {
                let valA, valB;
                
                if (sortField === 'date') {
                    valA = a.createdAt;
                    valB = b.createdAt;
                } else if (sortField === 'price') {
                    valA = a.price || 0;
                    valB = b.price || 0;
                } else if (sortField === 'category') {
                    valA = a.category;
                    valB = b.category;
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Clear Button Logic
            const clearBtn = document.getElementById('clear-btn');
            if (currentFilter === 'completed' && filteredItems.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            const listElement = document.getElementById('shopping-list');
            const emptyState = document.getElementById('empty-state');
            listElement.innerHTML = '';
            
            if (filteredItems.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
                
                filteredItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = `relative bg-white rounded-3xl p-4 border border-stone-100 shadow-sm hover:shadow-md transition-all ${item.completed ? 'bg-stone-50/80' : ''}`;
                    
                    const checkboxColor = item.completed ? (currentTheme.checked || '#ccc') : '';
                    const twdPrice = calculateTWD(item.price, item.currency);
                    
                    // Price Display Logic
                    let priceDisplay = '';
                    if (item.completed && item.actualPrice) {
                        const actualTwd = calculateTWD(item.actualPrice, item.actualCurrency || item.currency);
                         priceDisplay = `
                            <div class="flex flex-col text-right">
                                <span class="text-[10px] text-stone-300 line-through">é ä¼° ${item.currency} ${item.price}</span>
                                <span class="text-[10px] font-bold text-green-500 bg-green-50 px-1 rounded">å¯¦ä»˜ ${item.actualCurrency || item.currency} ${item.actualPrice}</span>
                                <span class="text-xs font-bold text-green-600">ç´„ NT$ ${actualTwd.toLocaleString()}</span>
                            </div>
                        `;
                    } else {
                        priceDisplay = item.price ? `
                            <div class="flex flex-col text-right">
                                <span class="text-[10px] text-stone-400">${item.currency} ${item.price.toLocaleString()}</span>
                                <span class="text-sm font-bold text-stone-600">ç´„ NT$ ${twdPrice.toLocaleString()}</span>
                            </div>
                        ` : '<span class="text-xs text-stone-300">--</span>';
                    }

                    // Avatar / Image Logic
                    let imageHtml = '';
                    let displayImg = item.purchaseImg || item.img; // Prioritize purchase image if completed
                    
                    if(displayImg) {
                        imageHtml = `<img src="${displayImg}" class="w-full h-full object-cover">`;
                    } else {
                        const cat = categoryData[item.category] || categoryData.general;
                        imageHtml = `
                            <div class="auto-avatar" style="background-color: ${cat.color};">
                                <i class="fa-solid ${cat.icon} opacity-60 text-white"></i>
                            </div>
                        `;
                    }

                    li.innerHTML = `
                        <div class="flex gap-3">
                            <!-- Checkbox -->
                            <div class="pt-3">
                                <label class="cute-checkbox" style="${item.completed ? `background-color:${checkboxColor};border-color:${checkboxColor}` : ''}">
                                    <input type="checkbox" class="hidden" ${item.completed ? 'checked' : ''} onchange="toggleItem(${item.id})">
                                </label>
                            </div>
                            
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-stone-700 text-base leading-tight ${item.completed ? 'strike-through opacity-50' : ''} pt-1 pl-1">${item.text}</h3>
                                    <button onclick="deleteItem(${item.id})" class="text-stone-200 hover:text-red-300 px-2 py-1"><i class="fa-solid fa-trash-can text-xs"></i></button>
                                </div>

                                <!-- Details Row -->
                                <div class="flex gap-3 items-end">
                                    <!-- Image -->
                                    <div class="w-16 h-16 rounded-2xl overflow-hidden flex-shrink-0 border border-stone-100 shadow-inner bg-stone-50">
                                        ${imageHtml}
                                    </div>

                                    <!-- Info -->
                                    <div class="flex-1 flex flex-col gap-1">
                                        ${item.note ? `
                                            <div class="text-[10px] text-stone-500 bg-stone-100/50 px-2 py-1 rounded-lg inline-block self-start">
                                                ${item.note}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="flex justify-end items-end w-full">
                                            ${priceDisplay}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    listElement.appendChild(li);
                });
            }

            // Stats
            const total = items.length;
            const completed = items.filter(i => i.completed).length;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        // Initialize
        applyTheme();
        fetchRates();
        render();
        
        window.onclick = function(event) {
            if (event.target == modal) closeModal();
            if (event.target == purchaseModal) closePurchaseModal();
        }
    </script>
</body>
</html>